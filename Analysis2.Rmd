---
title: "Analysis22"
author: "Chase Clark"
date: "January 19, 2019"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```


The IDBac version used to create the SQL was:  https://github.com/chasemc/IDBacApp/commit/9c7609ade28155e165c6e4319f12b55f6108b216

This can be installed via: 
devtools::install_github("chasemc/IDBacApp@9c7609a")

```{r message=FALSE, warning=FALSE}
library(RSQLite)
library(DBI)
library(dplyr)
library(magrittr)
library(MALDIquant)
```

```{r}
set.seed(42)
```


Connect to SQLite, show available tables
```{r}
sqliteFile <- "data/r01_replicates.sqlite"
sqliteFile <- "data/k2_calibration.sqlite"

con <- DBI::dbConnect(drv = RSQLite::SQLite(),
                      sqliteFile)
DBI::dbListTables(con)
```

All raw and processed spectra, peaklists are contained in the table "IndividualSpectra" 
```{r}
spectraTable <- dplyr::tbl(con, "IndividualSpectra")
```




```{r}
spectraTable %>% 
  filter(!is.na(proteinSpectrum)) %>% 
  select(Strain_ID, proteinSpectrum) %>% 
  collect %>% 
  return(.) -> proteinSpectraTable

proteinSpectraTable %>% 
  mutate(Strain_ID, Strain = sapply(strsplit(Strain_ID, "_"), "[", 1)) %>% 
  mutate(Strain_ID, Bio = sapply(strsplit(Strain_ID, "_"), "[", 3)) %>%
  mutate(Strain_ID, Tech = sapply(strsplit(Strain_ID, "_"), "[", 5)) %>%
  filter(Strain %in% c("A019","A046", "B004", "172-6")) %>% 
  return(.) -> proteinSpectraTable


z<- unlist(lapply(proteinSpectraTable$proteinSpectrum, function(x) unserialize(memDecompress(x, type= "gzip"))))

proteinSpectraTable %>% 
  mutate(proteinSpectrum = z ) -> proteinSpectraTable




proteinSpectraTable$proteinSpectrum <- lapply(proteinSpectraTable$proteinSpectrum, function(x){
  
  x@intensity <- x@intensity / max(x@intensity) *100
  x
})





```



```{r echo=FALSE}
proteinSpectraTable$proteinSpectrum %>% 
  MALDIquant::smoothIntensity(.,
                              method = "SavitzkyGolay", 
                              halfWindowSize = 20) %>% 
  MALDIquant::removeBaseline(.,
                             method = "TopHat") %>% 
  MALDIquant::detectPeaks(., 
                          method = "MAD", 
                          halfWindowSize = 20, 
                          SNR = 6)  %>% 
  return(.) -> p


p %>% 
  MALDIquant::trim(., c(4000, 20000)) -> proteinPeaks



biologicalReplicates <- paste0(proteinSpectraTable$Strain, "_", proteinSpectraTable$Bio)

groupedByBio <- split(proteinPeaks, biologicalReplicates)

ids <- sapply(strsplit(names(groupedByBio), "_"), "[", 1)

  # Merge technical replicates

theFunc <- function(bio, tech, boot){

  techReps <- tech
  bioReps <- bio
  
  techSpec <- lapply(groupedByBio, 
                     function(x){
                       x <- sample(x, techReps)
                       x <- MALDIquant::binPeaks(x,
                                                 method = "strict",
                                                 tolerance = 0.002)
                       x <- MALDIquant::filterPeaks(x, 
                                                    minFrequency = 0.5)
                       MALDIquant::mergeMassPeaks(x,
                                                  method = "sum",
                                                  ignore.na = FALSE)
                     })


  
  
  bioSpec <- lapply(split(techSpec, ids), 
                     function(x){
                       
                       x <- sample(x, bioReps)
                  
                       x <- MALDIquant::binPeaks(x,
                                                 method = "relaxed",
                                                 tolerance = 0.002)
                       x <- MALDIquant::filterPeaks(x, 
                                                    minFrequency = 0.5)
                       MALDIquant::mergeMassPeaks(x,
                                                  method = "sum",
                                                  ignore.na = FALSE)
                     })






binned <- MALDIquant::binPeaks(bioSpec, tolerance = .002)

binned <- intensityMatrix(binned)

binned[is.na(binned)] <- 0

binned <- 1 - coop::tcosine(binned)
colnames(binned) <- names(bioSpec)
diag(binned) <- NA



return(cbind.data.frame(binned,
      techReps = techReps,
      bioReps = bioReps,
      boot = boot
      ))

}



a<-expand.grid(1:3, 1:12)


  xa <- lapply(1:100,function(boot){
        print(boot)
 return(mapply(theFunc, bio = a$Var2, tech = a$Var1, boot = boot,  SIMPLIFY = FALSE))

    })
qaz <- xa
zap <- do.call(rbind.data.frame, unlist(xa, recursive = F))


```


```{r}
xa <- as.tbl(zap)

xa %>% 
  group_by(boot == 1) ->p
```

```{r}
zap %>% 
    filter(!is.na(B004)) %>%
    filter(is.na(A019)) %>% 
    
    ggplot() + 
    geom_boxplot(aes(y=B004, x=factor(bioReps),fill=factor(techReps)))
```




























```{r}

one <- dplyr::tibble("172-6" = NA,
                     A019 = binned[2, 1],
                     A046 = binned[3, 1],
                     B004 = binned[4, 1],
                     techReps = techReps,
                     bioReps = bioReps)
two <- dplyr::tibble("172-6" = binned[1, 2],
                     A019 = NA,
                     A046 = binned[3, 2],
                     B004 = binned[4, 2],
                     techReps = techReps,
                     bioReps = bioReps)

thr <- dplyr::tibble("172-6" = binned[1, 3],
                     A019 = binned[2, 3],
                     A046 = NA,
                     B004 = binned[4, 3],
                     techReps = techReps,
                     bioReps = bioReps)

fou <- dplyr::tibble("172-6" = binned[1, 4],
                     A019 = binned[2, 4],
                     A046 = binned[3, 4],
                     B004 = NA,
                     techReps = techReps,
                     bioReps = bioReps)



```




```{r}
a <- xa[[1]][[7]]
colnames(a) <- names(bioSpec)
rownames(a) <- names(bioSpec)
a[upper.tri(a, diag = T)] <- NA

a <- reshape2::melt(a)
a <- a[!is.na(a$value), ]
```







































  
  binvec <- lapply(sw, function(x) x@mass)
  zq <- IDBacApp::binnR(vectorList = binvec,
                        ppm = 2000, 
                        refSeqStart = 4000,
                        refSeqEnd = 15000)
  
  #  collected <- lapply(zq, function(x) S4Vectors::unique(S4Vectors::subjectHits(x)))
  collected <- lapply(zq, function(x) S4Vectors::unique(S4Vectors::subjectHits(x)))
  
  cvec <- sort(unique(unlist(collected)))
  
  zz<- lapply(collected, function(x) match(cvec, x))
  
  data <- do.call(rbind, zz)
  
  
  data <- base::as.matrix(data)
  # Change empty to 0
  data[base::is.na(data)] <- 0
  data[base::is.null(data)] <- 0
  
  
  stats::as.dist(1 - coop::tcosine(data))
  
 
 

172-6
```{r}
a <- zw[[1]]
a <- as.matrix(a)
a[upper.tri(a,diag = TRUE)] <- NA


z<-lapply(zw, function(x) { 
       
  x <- as.matrix(x)
  x[upper.tri(x,diag = TRUE)] <- NA
  x[,1]
  })

z <- do.call(rbind, z)
z <- as.data.frame(z)
boxplot(z, ylim = c(0,1), main = "172-6")
```


A019
```{r}
z<-lapply(zw, function(x) { 
       
  x <- as.matrix(x)
  x[upper.tri(x,diag = TRUE)] <- NA
  data.frame(`172=6` = x[2,1],
             A019 = NA,
             A046 = x[3,2],
             B004 = x[4,2]
             )
  })

z <- do.call(rbind, z)
z <- as.data.frame(z)
boxplot(z, ylim = c(0,1), main= "A019")

```


A046
```{r}
z<-lapply(zw, function(x) { 
       
  x <- as.matrix(x)
  x[upper.tri(x,diag = TRUE)] <- NA
  data.frame(`172-6` = x[3,1],
             A019 = x[3,2],
             A046 = NA,
             B004 = x[4,3])
})

z <- do.call(rbind, z)
z <- as.data.frame(z)

boxplot(z, ylim = c(0,1), main = "A046")

```


B004
```{r}
z<-lapply(zw, function(x) { 
       
  x <- as.matrix(x)
  x[upper.tri(x,diag = TRUE)] <- NA
  data.frame(`172-6` = x[4,1],
             A019 = x[4,2],
             A046 = x[4,3],
             B004 = NA)
  
  })

z <- do.call(rbind, z)
z <- as.data.frame(z)
boxplot(z, ylim = c(0,1), main= "B004")


```




























































```{r}
m2 <- lapply(p, mass)
m <- binnR(vectorlist = m2,
           ppm = 20000, 
           low = 2000, 
           high = 20000, 
           increment = 1)

z <- do.call(rbind,m)
z <- coop::tcosine(z)

```










## Biological variability.
Boxplots represent variability of technical-replicates cosine score within each of 12 biological replicates.

```{r echo=FALSE}




q3 <- lapply(grouped_by_strain, function(a){
  q <- lapply(1:100, function(xx){
    
    a1 <-  lapply(a, function(x) sample(x, 1))
    
    a1 %>% 
      unlist %>%
      MALDIquant::trim(., c(3000, 15000)) %>% 
      MALDIquant::binPeaks(.) %>% 
      MALDIquant::intensityMatrix() -> a2
    
    a2[is.na(a2)] <- 0
    a3 <- coop::tcosine(a2)
    
  })
  return(do.call(rbind, q))
})


par(mfrow=c(2,2))

for(i in seq_along(q3)){
  boxplot(q3[[i]], ylim= c(0,1), 
          main = names(q3)[[i]],
          xlab = "Biological Replicates",
          ylab = "Cosine Score")
}




```


```{r}

a <- grouped_by_strain[[2]]
# randomly sample one technical replicate within each biological replicate
a1 <-  lapply(a, function(x) sample(x, 1))


b <- grouped_by_strain[[3]]
# randomly sample one technical replicate within each biological replicate
b1 <-  lapply(b, function(x) sample(x, 1))


binned <- MALDIquant::binPeaks(unlist(list(a1,b1), recursive = T))

binned <- intensityMatrix(binned)

binned[is.na(binned)] <- 0

binned <- coop::tcosine(binned)

d <- binned
d[upper.tri(d, diag = T)] <- NA

a1 <- as.vector(d[1:12, 1:12])
a2 <- as.vector(d[13:24, 1:12])
a3 <- as.vector(d[13:24, 13:24])

a1 <- a1[!is.na(a1)]
a2 <- a2[!is.na(a2)]
a3 <- a3[!is.na(a3)]




```


```{r eval=FALSE, include=FALSE}
t.test(a2,a1)
t.test(a2,a3)

B      <- 1000
t.vect <- vector(length=B)
p.vect <- vector(length=B)

for(i in 1:B){
  boot.c <- sample(a1, size=3, replace=T)
  boot.p <- sample(a2, size=3, replace=T)
  ttest  <- t.test(boot.c, boot.p)
  t.vect[i] <- ttest$statistic
  p.vect[i] <- ttest$p.value
}

windows()
qqplot(t.vect, distribution="t", df=42)

```



```{r eval=FALSE, include=FALSE}
ppmv <- do.call(rbind, ppmv)
colnames(ppmv)[[5]] <- "ppm"


ggplot(data = ppmv) + 
  geom_density(aes(x=value, y= ..density.., fill = groups), alpha=0.4) +
  coord_cartesian(xlim = c(0,1)) +
  scale_fill_discrete(name = "Cosine Similarity Between:") +
  ggtitle("Cosine similarity between Bacillus and Proteobacteria") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Cosine Similarity") +
  ylab("Density") +
  facet_wrap(~`ppm`, scales ="free_y")
```


