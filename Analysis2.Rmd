---
title: "Analysis3"
author: "Chase Clark"
date: "January 23, 2019"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
self_contained: true
---

```{r setup, include=FALSE, }
knitr::opts_chunk$set(echo = F, cache=TRUE)
```


The IDBac version used to create the SQL was:  https://github.com/chasemc/IDBacApp/commit/9c7609ade28155e165c6e4319f12b55f6108b216

This can be installed via: 
devtools::install_github("chasemc/IDBacApp@9c7609a")


Means and standard deviations were computed by 1,000 random-sample bootstraps.



```{r message=FALSE, warning=FALSE}
library(RSQLite)
library(DBI)
library(dplyr)
library(magrittr)
library(MALDIquant)
library(ggplot2)
library(gridExtra)
library(grid)
```

```{r}
set.seed(42)
```


```{r}
con <- IDBacApp::createPool(fileName = "replicate_study", 
                            filePath = here::here("data",
                                                  "sqlite"))[[1]]

DBI::dbListTables(con)
```


Get the spcetra data
```{r}
spectraTable <- dplyr::tbl(con, "IndividualSpectra") %>% collect()
```




Get all peak data. In the the sample map technical replicates share the same name as the biological replicate.  That means  `IDBacApp::getPeakData` will return a list of lists of MALDIquant objects, where each element of the top list is a biological replicate that contains a list of technical replicate MALDIquant objects. Because this is confusing I will show the first two elements of the output...

`172-6_1` and `172-6_10` are biological replicates `1` and `10` of strain `172-6`. Each of these two biological replicates contains four technical replicates.

```{r}
peak_data <- IDBacApp::getPeakData(con, 
                                   sampleIDs = unique(spectraTable$Strain_ID),
                                   protein = T) 

minSNR <- 6
peak_data <- lapply(peak_data, function(temp){
  
  for (i in 1:length(temp)) {
    snr1 <-  which(MALDIquant::snr(temp[[i]]) >= minSNR)
    temp[[i]]@mass <- temp[[i]]@mass[snr1]
    temp[[i]]@snr <- temp[[i]]@snr[snr1]
    temp[[i]]@intensity <- temp[[i]]@intensity[snr1]
  }
  temp
})

peak_data <- lapply(peak_data, function(x) MALDIquant::trim(x, c(3000, 15000)))


#peak_data

#peak_data[1:2]
```


Not a good thing to do but a single biological replicate is missing a sample, here one will be copied as a fourth

```{r}
peak_data[[which(lengths(peak_data) == 3)]] <- c(peak_data[[which(lengths(peak_data) == 3)]], peak_data[[which(lengths(peak_data) == 3)]][[1]])
```




The below function will pull a random technical replicate and reandom biological replicate given the desired number of each.
```{r}

get_replicates <- function(peak_data,
                           sample_names,
                           bio_rep,
                           tech_rep) {
  lapply(sample_names, 
         function(name){
           y <-  peak_data[grep(name, names(peak_data))][sample(1:12, bio_rep)]
           y <- lapply(y, function(y) y[sample(1:4, tech_rep)])
           y
         })
}



```



```{r}

merge_tech_replicates <- function(z, 
                                  filter = NULL){
  lapply(z,
         function(x){
           
           lapply(x, 
                  function(y){
                    y <- MALDIquant::binPeaks(y,
                                              method = "relaxed",
                                              tolerance = 0.002)
                    if(!is.null(filter)) {
                      y <- MALDIquant::filterPeaks(y, 
                                                   minFrequency = filter)
                    }
                    MALDIquant::mergeMassPeaks(y,
                                               method = "mean",
                                               ignore.na = FALSE)
                  })
         })
}
merge_bio_replicates <- function(z, 
                                 filter = NULL){
  
  
  lapply(z, 
         function(y){
           y <- MALDIquant::binPeaks(y,
                                     method = "relaxed",
                                     tolerance = 0.2)
           if(!is.null(filter)) {
             y <- MALDIquant::filterPeaks(y, 
                                          minFrequency = filter)
           }
           MALDIquant::mergeMassPeaks(y,
                                      method = "mean",
                                      ignore.na = FALSE)
         })
  
}

```





```{r}

```


```{r}

saveRDS(peak_data,
        here::here("localonly",
                   "peak_data.rds"))
```




```{r}





numCores <- parallel::detectCores()
numCores <- parallel::makeCluster(numCores) 

pp <- parallel::parLapply(numCores, 1:2, 
                          function(i) {
                            set.seed(i)
                            peak_data <- readRDS(here::here("localonly",
                                                            "peak_data.rds"))
                            comb <-  expand.grid(1:12, 1:4)
                            
                            
                            get_replicates <- function(peak_data,
                                                       sample_names,
                                                       bio_rep,
                                                       tech_rep) {
                              lapply(sample_names, 
                                     function(name){
                                       y <-  peak_data[grep(name, names(peak_data))][sample(1:12, bio_rep)]
                                       y <- lapply(y, function(y) y[sample(1:4, tech_rep)])
                                       y
                                     })
                            }
                            
                            merge_tech_replicates <- function(z, 
                                                              filter = NULL){
                              lapply(z,
                                     function(x){
                                       
                                       lapply(x, 
                                              function(y){
                                                y <- MALDIquant::binPeaks(y,
                                                                          method = "relaxed",
                                                                          tolerance = 0.002)
                                                if(!is.null(filter)) {
                                                  y <- MALDIquant::filterPeaks(y, 
                                                                               minFrequency = filter)
                                                }
                                                MALDIquant::mergeMassPeaks(y,
                                                                           method = "mean",
                                                                           ignore.na = FALSE)
                                              })
                                     })
                            }
                            merge_bio_replicates <- function(z, 
                                                             filter = NULL){
                              
                              
                              lapply(z, 
                                     function(y){
                                       y <- MALDIquant::binPeaks(y,
                                                                 method = "relaxed",
                                                                 tolerance = 0.2)
                                       if(!is.null(filter)) {
                                         y <- MALDIquant::filterPeaks(y, 
                                                                      minFrequency = filter)
                                       }
                                       MALDIquant::mergeMassPeaks(y,
                                                                  method = "mean",
                                                                  ignore.na = FALSE)
                                     })
                              
                            }
                            
                            
                            mapply(function(x,
                                            y){
                              
                              z <- get_replicates(peak_data = peak_data,
                                                  sample_names = c("172-6", "A019", "A046", "B004"),
                                                  bio_rep = 6 ,
                                                  tech_rep = 3)
                              
                              
                              
                              z <- merge_tech_replicates(z, 
                                                         filter = NULL)
                              
                              
                              
                              
                              zz <- lapply(z, function(x){
                                
                                b <- IDBacApp::createFuzzyVector(massStart = 3000,
                                                                 massEnd = 16000, 
                                                                 ppm = 500, 
                                                                 massList = lapply(unlist(x), function(x)x@mass), 
                                                                 intensityList = lapply(unlist(x), function(x)x@intensity))
                                b <- 1 - coop::cosine(b)
                                list(strain = strsplit(names(x)[[1]], "_")[[1]][[1]],
                                     distance = b,
                                     vect = b[lower.tri(b)])
                              })
                              zz
                            },
                            x= comb$Var1,
                            y = comb$Var2)
                          })

parallel::stopCluster(numCores)
```




```{r}
ii<-2

yo <- do.call(rbind, lapply(seq_along(pp[[1]][ii,]), function(x) cbind.data.frame(pp[[1]][ii,][[x]]$vect,
                                      pp[[1]][ii,][[x]]$strain,
                                      x)))
colnames(yo) <- c("cosine", "strain", "iter")

yo <- cbind(yo, comb[match(yo$iter, rownames(comb)), ])

colnames(yo) <- c("cosine", "strain", "iter", "bio", "tech")

```




```{r}
ggplot(yo) + 
    geom_violin(aes(y=cosine, x=factor(tech))) + 
    facet_wrap(~bio, ncol = 12) + 
    coord_cartesian(ylim = c(0,1))

```









```{r}
a <-  lapply((pp, function(x){
  
  
  
cbind(do.call(rbind,   lapply(1:2, function(x) cbind(pp[[x]][[i]]$vect, x))), i)
  
  
  })
a <- do.call(rbind, a)

colnames(a) <- c("cosine", "iter", "biorep")


```









```{r}
pp <- readRDS("data/1000-boots.rds")
zap <- do.call(rbind.data.frame, unlist(pp, recursive = F))

```



# Boxplot Comparisons of Biological andf Technical Replicates 

This section shows the effects of 1 to 3 technical replicates at each of 12 biological replicates.

Technical replicates were used to create a merged peak list at each biological replicate, then each bioligcal replicate merged.
Peak-handling (eg binning settings) were kept the same for both technical and biological replicates. Percent peak presence was kept at 50% for both technical and biological replicates.


The boxplots below depict each of the four isolates against each other. 
As a reminder: 
- B004 and A046 share 100% 16S rRNA sequence
- A046 and A019 share 98.03% 16S rRNA sequence (29 nt)
- 172-6 is an *Enterococcus* sp.
See the Study Design  document for more details

## B004

### B004 vs A019

```{r}
zap %>% 
  filter(!is.na(B004)) %>%
  filter(is.na(A019)) -> pl

zap %>% 
  filter(!is.na(B004)) %>%
  filter(is.na(A046)) -> pl2

pl$Group <-"B004 vs A019"

pl2$Group <-"B004 vs A046"
combined <- rbind(pl, pl2)

combined %>%
  mutate(cc = paste0(Group, "- ", techReps, " technical")) -> combined



ggplot(combined) + 
  geom_boxplot(aes(y=B004, x=factor(bioReps),fill=factor(cc))) +
  coord_cartesian(ylim=c(0,1)) + 
  labs(colour="Technical Replicates") +
  xlab("Biological Replicates") +
  ylab("Cosine Similarity") +
  ggtitle(paste0("Effect of Technical Replication with Increasing Biological Replicates \n ",
                 one, " vs ", two)) +
  coord_cartesian(ylim=c(0,.2))




```

### B004 vs A046

```{r}
zap %>% 
  filter(!is.na(B004)) %>%
  filter(is.na(A046)) %>% 
  
  
  
  ggplot() + 
  geom_boxplot(aes(y=B004, x=factor(bioReps),fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```





### B004 vs 172-6


```{r}
zap %>% 
  filter(!is.na(B004)) %>%
  filter(is.na(`172-6`)) %>% 
  
  ggplot() + 
  geom_boxplot(aes(y=B004, x=factor(bioReps),fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```


## A046


### A046 vs 172-6


```{r}
zap %>% 
  filter(!is.na(A046)) %>%
  filter(is.na(`172-6`)) %>% 
  
  ggplot() + 
  geom_boxplot(aes(y=A046, x=factor(bioReps), fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```


### A046 vs A019


```{r}
zap %>% 
  filter(!is.na(A046)) %>%
  filter(is.na(A019)) %>% 
  
  ggplot() + 
  geom_boxplot(aes(y=A046, x=factor(bioReps), fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```


### A046 vs B004


```{r}
zap %>% 
  filter(!is.na(A046)) %>%
  filter(is.na(B004)) %>% 
  
  ggplot() + 
  geom_boxplot(aes(y=A046, x=factor(bioReps), fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```



## A019


### A019 vs 172-6


```{r}
zap %>% 
  filter(!is.na(A019)) %>%
  filter(is.na(`172-6`)) %>% 
  
  ggplot() + 
  geom_boxplot(aes(y=A019, x=factor(bioReps), fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```


### A019 vs A046


```{r}
zap %>% 
  filter(!is.na(A019)) %>%
  filter(is.na(A046)) %>% 
  
  ggplot() + 
  geom_boxplot(aes(y=A019, x=factor(bioReps), fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```


### A019 vs B004


```{r}
zap %>% 
  filter(!is.na(A019)) %>%
  filter(is.na(B004)) %>% 
  
  ggplot() + 
  geom_boxplot(aes(y=A019, x=factor(bioReps), fill=factor(techReps)))+
  coord_cartesian(ylim=c(0,1))
```




