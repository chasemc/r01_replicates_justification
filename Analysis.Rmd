---
title: "Analysis"
author: "Chase Clark"
date: "January 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The IDBac version used to create the SQL was:  https://github.com/chasemc/IDBacApp/commit/9c7609ade28155e165c6e4319f12b55f6108b216

This can be installed via: 
devtools::install_github("chasemc/IDBacApp@9c7609a")

```{r}
library(RSQLite)
library(DBI)
library(dplyr)
library(magrittr)
library(MALDIquant)
```

Connect to SQLite, show available tables
```{r}
sqliteFile <- "data/r01_replicates.sqlite"


con <- DBI::dbConnect(drv = RSQLite::SQLite(),
                      sqliteFile)
DBI::dbListTables(con)
```

All raw and processed spectra, peaklists are contained in the table "IndividualSpectra" 
```{r}
spectraTable <- dplyr::tbl(con, "IndividualSpectra")
```


```{r}
sampleIDs <- spectraTable %>% pull(Strain_ID)
sampleIDs <- sampleIDs[sampleIDs != "BTS"]
sampleIDs <- sampleIDs[sampleIDs != "NA"]
```

There was one sample that wound up not having 8-technical replicates, so every bio rep needs to have 1 tech rep renadomly removed:
```{r}
a<-(sapply(sampleIDs, function(x) strsplit(x, "_")[[1]][[1]]))
b<-(sapply(sampleIDs, function(x) strsplit(x, "_")[[1]][[3]]))
sort(table(paste0(a, "_", b)))
```


Get the spectra shas, and group by biological replicate
```{r}
spectraTable %>% 
  filter(!is.na(proteinPeaks)) %>% 
  select(spectrumSHA, Strain_ID) %>% 
  filter(!Strain_ID %in% c("NA", "BTS")) %>% 
  collect %>% 
  return(.) -> shas

shas %>% 
  mutate(Strain_ID, BioRep = paste0(sapply(strsplit(Strain_ID, "_"), "[", 1),
                                    "_",
                                    sapply(strsplit(Strain_ID, "_"), "[", 3))) %>%  
  return(.) -> shas

```

```{r}
grouped <- split(shas, shas$BioRep)

```

Get Protein Peaks
```{r}
proteinPeaks <- lapply(grouped, function(x){
  
  spectraTable %>% 
    filter(spectrumSHA %in% x$spectrumSHA) %>% 
    select(proteinPeaks) %>% collect 
  
})
```

Decompress, unserialize
```{r}
proteinPeaks <- lapply(proteinPeaks, function(x){
  
  unlist(lapply(x[[1]], function(y){
  unserialize(memDecompress(y, type= "gzip"))
  }))
})
```







