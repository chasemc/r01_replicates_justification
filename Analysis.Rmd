---
title: "Analysis"
author: "Chase Clark"
date: "January 19, 2019"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```


The IDBac version used to create the SQL was:  https://github.com/chasemc/IDBacApp/commit/9c7609ade28155e165c6e4319f12b55f6108b216

This can be installed via: 
devtools::install_github("chasemc/IDBacApp@9c7609a")

```{r message=FALSE, warning=FALSE}
library(RSQLite)
library(DBI)
library(dplyr)
library(magrittr)
library(MALDIquant)
```


Connect to SQLite, show available tables
```{r}
sqliteFile <- "data/r01_replicates.sqlite"


con <- DBI::dbConnect(drv = RSQLite::SQLite(),
                      sqliteFile)
DBI::dbListTables(con)
```

All raw and processed spectra, peaklists are contained in the table "IndividualSpectra" 
```{r}
spectraTable <- dplyr::tbl(con, "IndividualSpectra")
```


```{r}
sampleIDs <- spectraTable %>% pull(Strain_ID)
sampleIDs <- sampleIDs[sampleIDs != "BTS"]
sampleIDs <- sampleIDs[sampleIDs != "NA"]
```

There was one sample that wound up not having 8-technical replicates, so every bio rep will have 1 technical replicate randomly removed:
```{r}
a <- sapply(strsplit(sampleIDs, "_"), "[", 1)
b <- sapply(strsplit(sampleIDs, "_"), "[", 3)
sort(table(paste0(a, "_", b)))
```

# Whole-spectrum comparisons:

## Biological + Technical
1: Summarise whole-spectrum comparisons within strains (biological replicates + technical replicates)
```{r}
spectraTable %>% 
  filter(!is.na(proteinSpectrum)) %>% 
  select(Strain_ID, proteinSpectrum) %>% 
  collect %>% 
  return(.) -> proteinSpectraTable

proteinSpectraTable %>% 
  mutate(Strain_ID, Strain = sapply(strsplit(Strain_ID, "_"), "[", 1)) %>% 
  mutate(Strain_ID, Bio = sapply(strsplit(Strain_ID, "_"), "[", 3)) %>%
  mutate(Strain_ID, Tech = sapply(strsplit(Strain_ID, "_"), "[", 5)) %>%
  filter(Strain %in% c("A019","A046", "B004", "172-6")) %>% 
  return(.) -> proteinSpectraTable


z<- unlist(lapply(proteinSpectraTable$proteinSpectrum, function(x) unserialize(memDecompress(x, type= "gzip"))))

proteinSpectraTable %>% 
  mutate(proteinSpectrum = z ) -> proteinSpectraTable




proteinSpectraTable$proteinSpectrum <- lapply(proteinSpectraTable$proteinSpectrum, function(x){
  
  x@intensity <- x@intensity / max(x@intensity)
  x
})



```


- Streptomyces, overall, had a greater variability than the Enterococcus strain in whole-spectra; and A019 had the most.

```{r}


protein <- split(proteinSpectraTable$proteinSpectrum, proteinSpectraTable$Strain)

w<-Vectorize(MALDIquant::intensity, "object")

compared <- lapply(protein, 
                   function(x){
                     
                   coop::cosine(w(x))
                     
  
})

par(mfrow = c(2,2))

for(i in seq_along(compared)){

plot(compared[[i]], 
     xlim = c(0.4, 1),
     ylim = c(0.4, 1), 
     xlab = "Cosine",
     ylab = "Cosine",
     main = names(compared)[[i]])

}
```

## Biological 

2: Compare technical replicates within each biological replicate

- Cosine similarities of technical replicates are very similar


Of note: A019_1, A046_2, 
```{r}


protein <- split(proteinSpectraTable$proteinSpectrum, 
                 paste0(proteinSpectraTable$Strain, "_", proteinSpectraTable$Bio))

w<-Vectorize(MALDIquant::intensity, "object")

compared <- lapply(protein, 
                   function(x){
                     
                   coop::cosine(w(x))
                     
  
})


par(mfrow = c(3,4))

for(i in seq_along(compared)){
    
    plot(compared[[i]], 
         xlim = c(0.5, 1),
         ylim = c(0.5, 1), 
         xlab = "Cosine",
         ylab = "Cosine",
         main = names(compared)[[i]])
    
}
```


```{r eval=FALSE, include=FALSE}
for(i in seq_along(protein)){
  png(filename = paste0("images/techReps/", names(protein)[[i]], ".png"),
      width = 900, 
      height = 600,
      units = "px")
  
  par(mfrow = c(2,2))
  
  for(x in seq_along(protein[[i]])){
    plot(protein[[i]][[x]], main = protein[[i]][[x]]@metaData$Strain)
  }
  dev.off()
  
} 
```

```{r eval=FALSE, include=FALSE}
spectraTable %>% 
  filter(!is.na(smallMoleculeSpectrum)) %>% 
  select(Strain_ID, smallMoleculeSpectrum) %>% 
  collect %>% 
  return(.) -> proteinSpectraTable

proteinSpectraTable %>% 
  mutate(Strain_ID, Strain = sapply(strsplit(Strain_ID, "_"), "[", 1)) %>% 
  mutate(Strain_ID, Bio = sapply(strsplit(Strain_ID, "_"), "[", 3)) %>%
  mutate(Strain_ID, Tech = sapply(strsplit(Strain_ID, "_"), "[", 5)) %>%
  filter(Strain %in% c("A019","A046", "B004", "172-6")) %>% 
  return(.) -> proteinSpectraTable


z<- unlist(lapply(proteinSpectraTable$smallMoleculeSpectrum, function(x) unserialize(memDecompress(x, type= "gzip"))))

proteinSpectraTable %>% 
  mutate(smallMoleculeSpectrum = z ) -> proteinSpectraTable




proteinSpectraTable$proteinSpectrum <- lapply(proteinSpectraTable$smallMoleculeSpectrum, function(x){
  
  x@intensity <- x@intensity / max(x@intensity)
  x
})


protein <- split(proteinSpectraTable$proteinSpectrum, 
                 paste0(proteinSpectraTable$Strain, "_", proteinSpectraTable$Bio))
for(i in seq_along(protein)){
  png(filename = paste0("images/techReps/small/", names(protein)[[i]], ".png"),
      width = 900, 
      height = 600,
      units = "px")
  
  par(mfrow = c(2,2))
  
  for(x in seq_along(protein[[i]])){
    plot(protein[[i]][[x]], main = protein[[i]][[x]]@metaData$Strain)
  }
  dev.off()
  
} 
```


----



```{r}

spectraTable %>% 
  filter(!is.na(proteinSpectrum)) %>% 
  select(Strain_ID, proteinSpectrum) %>% 
  collect %>% 
  return(.) -> proteinSpectraTable

proteinSpectraTable %>% 
  mutate(Strain_ID, Strain = sapply(strsplit(Strain_ID, "_"), "[", 1)) %>% 
  mutate(Strain_ID, Bio = sapply(strsplit(Strain_ID, "_"), "[", 3)) %>%
  mutate(Strain_ID, Tech = sapply(strsplit(Strain_ID, "_"), "[", 5)) %>%
  filter(Strain %in% c("A019")) %>%
  filter(Bio == 1) %>%
  return(.) -> proteinSpectraTable


z<- unlist(lapply(proteinSpectraTable$proteinSpectrum, function(x) unserialize(memDecompress(x, type= "gzip"))))

```


A019_Bio_1_tech_2 is a bad spectrum
```{r}
par(mfrow = c(2,2))
for(i in seq_along(z)){
plot(z[[i]], main = z[[i]]@metaData$Strain)
}
```

----


```{r}

spectraTable %>% 
  filter(!is.na(proteinSpectrum)) %>% 
  select(Strain_ID, proteinSpectrum) %>% 
  collect %>% 
  return(.) -> proteinSpectraTable

proteinSpectraTable %>% 
  mutate(Strain_ID, Strain = sapply(strsplit(Strain_ID, "_"), "[", 1)) %>% 
  mutate(Strain_ID, Bio = sapply(strsplit(Strain_ID, "_"), "[", 3)) %>%
  mutate(Strain_ID, Tech = sapply(strsplit(Strain_ID, "_"), "[", 5)) %>%
  filter(Strain %in% c("A046")) %>%
  filter(Bio == 2) %>%
  return(.) -> proteinSpectraTable


z<- unlist(lapply(proteinSpectraTable$proteinSpectrum, function(x) unserialize(memDecompress(x, type= "gzip"))))


```


A046_Bio_2_tech_1 is a bad spectrum
```{r}
par(mfrow = c(2,2))
for(i in seq_along(z)){
plot(z[[i]], main = z[[i]]@metaData$Strain)
}

```






----



----















```{r}
#Get the spectra shas, and group by biological replicate
spectraTable %>% 
  filter(!is.na(proteinPeaks)) %>% 
  select(spectrumSHA, Strain_ID) %>% 
  filter(!Strain_ID %in% c("NA", "BTS")) %>% 
  collect %>% 
  return(.) -> shas

shas %>% 
  mutate(Strain_ID, BioRep = paste0(sapply(strsplit(Strain_ID, "_"), "[", 1),
                                    "_",
                                    sapply(strsplit(Strain_ID, "_"), "[", 3))) %>%  
  return(.) -> shas

```

```{r}
#split and then renadomly take three tech reps for each bio rep
grouped <- split(shas, shas$BioRep)
grouped <- lapply(grouped, function(x) x[sample(1:nrow(x), 3), ] )
```

```{r}
#Get Protein Peaks
proteinPeaks <- lapply(grouped, function(x){
  
  spectraTable %>% 
    filter(spectrumSHA %in% x$spectrumSHA) %>% 
    select(proteinPeaks) %>% collect 
  
})
```

```{r}
#Decompress, unserialize
proteinPeaks <- lapply(proteinPeaks, function(x){
  
  unlist(lapply(x[[1]], function(y){
  y <- unserialize(memDecompress(y, type= "gzip"))
  for(i in y){
   i@intensity <- i@intensity * 100 / max(i@intensity)
}
  return(i)
  }))
})
```


```{r}
strains <- sapply(strsplit(names(proteinPeaks), "_"),"[",1)
grouped_by_strain <- split(proteinPeaks, strains)
```
# Peaks Variability

## Technical variability.
Boxplots represent variability of technical-replicates cosine score within each of 12 biological replicates.

```{r echo=FALSE}


z  <-lapply(grouped_by_strain, 
       function(x){
         
         lapply(x, function(y){
           
          y <- MALDIquant::trim(y, c(3000, 15000)) 
             a <- MALDIquant::intensityMatrix(MALDIquant::binPeaks(y))
             a[is.na(a)] <- 0
             coop::tcosine(a)
         })
         
  
})



zz <- lapply(z, function(y){
  lapply(y, function(x){
  
 x <- as.vector(x)
  as.data.frame(x)
})
})
zz <- lapply(zz, function(x){
  
        x <- do.call(cbind, x)
        colnames(x) <- 1:12
        x
  })

par(mfrow=c(2,2))

for(i in seq_along(zz)){
boxplot(zz[[i]], ylim= c(0,1), 
        main = names(zz)[[i]],
        xlab = "Biological Replicates",
        ylab = "Cosine Score")
}


```




## Biological variability.
Boxplots represent variability of technical-replicates cosine score within each of 12 biological replicates.

```{r echo=FALSE}




q3 <- lapply(grouped_by_strain, function(a){
q <- lapply(1:100, function(xx){
  
  a1 <-  lapply(a, function(x) sample(x, 1))
  
  a1 %>% 
    unlist %>%
    MALDIquant::trim(., c(3000, 15000)) %>% 
    MALDIquant::binPeaks(.) %>% 
    MALDIquant::intensityMatrix() -> a2
  
  a2[is.na(a2)] <- 0
  a3 <- coop::tcosine(a2)
  
})
return(do.call(rbind, q))
})


par(mfrow=c(2,2))

for(i in seq_along(q3)){
boxplot(q3[[i]], ylim= c(0,1), 
        main = names(q3)[[i]],
        xlab = "Biological Replicates",
        ylab = "Cosine Score")
}


         
  
```


```{r}

a <- grouped_by_strain[[2]]
# randomly sample one technical replicate within each biological replicate
a1 <-  lapply(a, function(x) sample(x, 1))


b <- grouped_by_strain[[3]]
# randomly sample one technical replicate within each biological replicate
b1 <-  lapply(b, function(x) sample(x, 1))


binned <- MALDIquant::binPeaks(unlist(list(a1,b1), recursive = T))

binned <- intensityMatrix(binned)

binned[is.na(binned)] <- 0

binned <- coop::tcosine(binned)

d <- binned
d[upper.tri(d, diag = T)] <- NA

a1 <- as.vector(d[1:12, 1:12])
a2 <- as.vector(d[13:24, 1:12])
a3 <- as.vector(d[13:24, 13:24])

a1 <- a1[!is.na(a1)]
a2 <- a2[!is.na(a2)]
a3 <- a3[!is.na(a3)]




```


```{r eval=FALSE, include=FALSE}
t.test(a2,a1)
t.test(a2,a3)

B      <- 1000
t.vect <- vector(length=B)
p.vect <- vector(length=B)

for(i in 1:B){
  boot.c <- sample(a1, size=3, replace=T)
  boot.p <- sample(a2, size=3, replace=T)
  ttest  <- t.test(boot.c, boot.p)
  t.vect[i] <- ttest$statistic
  p.vect[i] <- ttest$p.value
}

windows()
  qqplot(t.vect, distribution="t", df=42)

```



```{r eval=FALSE, include=FALSE}
ppmv <- do.call(rbind, ppmv)
colnames(ppmv)[[5]] <- "ppm"


ggplot(data = ppmv) + 
    geom_density(aes(x=value, y= ..density.., fill = groups), alpha=0.4) +
    coord_cartesian(xlim = c(0,1)) +
    scale_fill_discrete(name = "Cosine Similarity Between:") +
    ggtitle("Cosine similarity between Bacillus and Proteobacteria") +
    theme(plot.title = element_text(hjust = 0.5)) +
    xlab("Cosine Similarity") +
    ylab("Density") +
    facet_wrap(~`ppm`, scales ="free_y")
```


